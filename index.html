<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nochi Kasa Mobil</title>
    <meta name="theme-color" content="#1a202c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" href="logo.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { background-color: #1a202c; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-dark { background-color: #0f172a; border: 1px solid #334155; color: white; transition: all 0.3s; }
        .input-dark:focus { border-color: #6366f1; outline: none; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .hp-field { opacity: 0; position: absolute; top: -9999px; left: -9999px; }
    </style>
</head>
<body class="p-4 md:p-8 pb-20">

    <div id="setupScreen" class="max-w-md mx-auto glass-panel p-6 rounded-2xl shadow-xl mt-10 hidden">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-white">Cihaz Eşleştirme</h2>
            <p class="text-gray-400 text-sm mt-1">Bilgisayar ekranındaki özel QR kodunuzu okutun veya Hash kodunu elle girin.</p>
        </div>
        
        <div id="reader" class="w-full mb-4 rounded-xl overflow-hidden hidden border border-indigo-500/30"></div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm text-gray-400 mb-1">Eşleştirme Kodu</label>
                <div class="flex space-x-2">
                    <input type="text" id="setupHash" class="w-full input-dark rounded-lg p-3" placeholder="QR Okut veya Yapıştır">
                    
                    <button onclick="startScanner()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 rounded-lg transition-colors flex items-center justify-center shadow-lg" title="QR Kodu Tara">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </button>
                </div>
            </div>
            
            <button id="btnSaveSetup" onclick="saveSetup()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg transition-colors">Eşleşmeyi Tamamla</button>
            <button id="btnStopScan" onclick="stopScanner()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition-colors hidden">Kamerayı Kapat</button>
        </div>
    </div>

    <div id="appScreen" class="max-w-md mx-auto hidden">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-xl font-bold text-white">Yeni İşlem Ekle</h1>
                <p id="lblActiveUser" class="text-sm text-emerald-400 font-bold mt-1"></p>
            </div>
            <button onclick="clearSetup()" class="text-xs text-red-400 border border-red-400 px-2 py-1 rounded hover:bg-red-400 hover:text-white transition">Çıkış Yap</button>
        </div>

        <form id="transactionForm" class="space-y-5" onsubmit="event.preventDefault(); saveTransaction();">
            
            <input type="text" id="hp_website" class="hp-field" tabindex="-1" autocomplete="off">

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Tarih</label>
                    <input type="date" id="frmDate" required class="w-full input-dark rounded-lg p-2.5">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Saat</label>
                    <input type="time" id="frmTime" required class="w-full input-dark rounded-lg p-2.5">
                </div>
            </div>

            <div class="glass-panel p-4 rounded-xl space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">İşlem Türü *</label>
                    <select id="frmType" required onchange="filterCategories()" class="w-full input-dark rounded-lg p-2.5">
                        <option value="GELİR">Gelir (+)</option>
                        <option value="GİDER">Gider (-)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-1">Kasa *</label>
                    <select id="frmSafe" required onchange="checkCurrency()" class="w-full input-dark rounded-lg p-2.5">
                        <option value="">Yükleniyor...</option>
                    </select>
                </div>

                <div id="foreignCurrencyDiv" class="hidden grid grid-cols-2 gap-4 border border-indigo-500/30 p-3 rounded-lg bg-indigo-900/10">
                    <div>
                        <label class="block text-sm text-indigo-300 mb-1">Döviz Tutarı</label>
                        <input type="number" step="0.01" id="frmForeignAmount" onkeyup="calcTl()" class="w-full input-dark rounded-lg p-2">
                    </div>
                    <div>
                        <label class="block text-sm text-indigo-300 mb-1">Kur</label>
                        <input type="number" step="0.0001" id="frmRate" value="1" onkeyup="calcTl()" class="w-full input-dark rounded-lg p-2">
                    </div>
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-1">TL Tutarı *</label>
                    <div class="relative">
                        <input type="number" step="0.01" id="frmAmount" required class="w-full input-dark rounded-lg p-3 text-xl font-bold">
                        <span class="absolute right-4 top-3 text-gray-500 font-bold">₺</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">KDV %</label>
                        <input type="number" id="frmKdv" value="0" class="w-full input-dark rounded-lg p-2.5">
                    </div>
                    <div class="flex items-end pb-2">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="frmKdvIncluded" checked class="form-checkbox h-5 w-5 text-indigo-600 rounded bg-gray-800 border-gray-600 focus:ring-indigo-600 focus:ring-offset-gray-900">
                            <span class="text-sm text-gray-300">KDV Dahil</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-4 rounded-xl space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Kategori *</label>
                    <select id="frmCat" required class="w-full input-dark rounded-lg p-2.5">
                        <option value="">Yükleniyor...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Cari Seçimi (Opsiyonel)</label>
                    <select id="frmCari" class="w-full input-dark rounded-lg p-2.5">
                        <option value="">Cari Yok</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Açıklama</label>
                    <textarea id="frmDesc" rows="2" class="w-full input-dark rounded-lg p-2.5"></textarea>
                </div>
            </div>

            <button type="submit" id="btnSave" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-emerald-900/50 transition-all active:scale-95 text-lg">
                İşlemi Gönder
            </button>
        </form>
    </div>

    <script>
        const AES_KEY = CryptoJS.enc.Utf8.parse("NochiProject_Secret_Key_2026_XYZ");
        const TURSO_URL = "https://nkt-db-nochi.aws-eu-west-1.turso.io/v2/pipeline";
        const TURSO_TOKEN = "eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJhIjoicnciLCJpYXQiOjE3NzE2ODAwMTcsImlkIjoiN2QwMWNjZjEtNmVhZS00ZTQ1LTg5NjMtMmFhNjMyY2IxMzI5IiwicmlkIjoiZWRiNzU5ODQtYzIxOS00M2E2LWIwZDItZjgwOTk0ZTdiZWM5In0.gH30D2mgBJ4wk7Wj6a1h1xv9uL5FHnNX3ZFGH1etAlha0j3fmfhL1WsawoyoDjAFyjy1wAapFTSyubMH7AKFBA";
        
        let tenantHash = "";
        let username = "";
        let userHash = "";
        let allCategories = [];
        let allSafes = [];
        let html5QrCode;

        window.onload = () => {
            const now = new Date();
            document.getElementById('frmDate').value = now.toISOString().split('T')[0];
            document.getElementById('frmTime').value = now.toTimeString().substring(0,5);

            tenantHash = localStorage.getItem('nkt_tenant_hash');
            username = localStorage.getItem('nkt_username');
            userHash = localStorage.getItem('nkt_user_hash');

            if (tenantHash && username && userHash) {
                document.getElementById('setupScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                document.getElementById('lblActiveUser').innerText = "Kullanıcı: " + username;
                fetchDefinitions();
            } else {
                document.getElementById('setupScreen').classList.remove('hidden');
            }
        };

        function startScanner() {
            document.getElementById('reader').classList.remove('hidden');
            document.getElementById('btnStopScan').classList.remove('hidden');
            document.getElementById('btnSaveSetup').classList.add('hidden');
            
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrCode.start({ facingMode: "environment" }, config, 
            (decodedText) => {
                document.getElementById('setupHash').value = decodedText;
                stopScanner();
                saveSetup(); 
            }, 
            (errorMessage) => { }).catch((err) => {
                Swal.fire('Kamera Hatası', 'Kameraya erişilemedi.', 'error');
                stopScanner();
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('reader').classList.add('hidden');
                    document.getElementById('btnStopScan').classList.add('hidden');
                    document.getElementById('btnSaveSetup').classList.remove('hidden');
                }).catch(err => console.log("Hata:", err));
            }
        }

        function saveSetup() {
            const hashInput = document.getElementById('setupHash').value.trim();
            const parts = hashInput.split('|');
            
            if (parts.length === 3) {
                localStorage.setItem('nkt_tenant_hash', parts[0]);
                localStorage.setItem('nkt_username', parts[1]);
                localStorage.setItem('nkt_user_hash', parts[2]);
                location.reload();
            } else {
                Swal.fire('Hata', 'Geçersiz Eşleştirme Kodu.', 'warning');
            }
        }

        function clearSetup() {
            Swal.fire({
                title: 'Çıkış Yapılsın mı?',
                text: "Yeniden girmek için tekrar QR kod okutmanız gerekir.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Evet, Çıkış Yap'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('nkt_tenant_hash');
                    localStorage.removeItem('nkt_username');
                    localStorage.removeItem('nkt_user_hash');
                    location.reload();
                }
            });
        }

        async function runTursoQuery(sql, args = []) {
            const payload = {
                requests: [
                    { type: "execute", stmt: { sql: sql, args: args } },
                    { type: "close" }
                ]
            };
            const response = await fetch(TURSO_URL, {
                method: "POST",
                headers: { "Authorization": "Bearer " + TURSO_TOKEN, "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            return await response.json();
        }

        function decryptData(base64Str) {
            try {
                var rawData = CryptoJS.enc.Base64.parse(base64Str);
                var iv = CryptoJS.lib.WordArray.create(rawData.words.slice(0, 4));
                var ciphertext = CryptoJS.lib.WordArray.create(rawData.words.slice(4));
                
                var decrypted = CryptoJS.AES.decrypt(
                    { ciphertext: ciphertext },
                    AES_KEY,
                    { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }
                );
                return decrypted.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                return null;
            }
        }

        function encryptData(text) {
            const iv = CryptoJS.lib.WordArray.random(16);
            const encrypted = CryptoJS.AES.encrypt(text, AES_KEY, {
                iv: iv,
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.Pkcs7
            });
            const combined = iv.clone().concat(encrypted.ciphertext);
            return CryptoJS.enc.Base64.stringify(combined);
        }

        async function fetchDefinitions() {
            try {
                const res = await runTursoQuery(`SELECT Type, DataId, EncryptedJson FROM Def_${tenantHash}`);
                
                if (!res.results || !res.results[0].response.result) {
                    throw new Error("Geçersiz hash veya tablo yok.");
                }
                
                const rows = res.results[0].response.result.rows;
                
                const safeSel = document.getElementById('frmSafe');
                const catSel = document.getElementById('frmCat');
                const cariSel = document.getElementById('frmCari');
                
                safeSel.innerHTML = '<option value="">Seçiniz</option>';
                catSel.innerHTML = '<option value="">Seçiniz</option>';
                cariSel.innerHTML = '<option value="">Cari Yok</option>';

                allCategories = [];
                allSafes = [];

                rows.forEach(r => {
                    const type = r[0].value;
                    const id = r[1].value;
                    const encryptedJson = r[2].value;

                    const decryptedStr = decryptData(encryptedJson);
                    if (!decryptedStr) return; 

                    const dataObj = JSON.parse(decryptedStr);
                    const name = dataObj.Name;
                    const curr = dataObj.CurrencyCode || '';

                    if(type === 'SAFE') {
                        allSafes.push({id, name, curr});
                        safeSel.innerHTML += `<option value="${id}" data-curr="${curr}">${name} (${curr})</option>`;
                    } else if(type.startsWith('CAT_')) {
                        allCategories.push({id, name, type: type.replace('CAT_','')});
                    } else if(type === 'CARI') {
                        cariSel.innerHTML += `<option value="${id}">${name}</option>`;
                    }
                });

                filterCategories();
            } catch (error) {
                console.error(error);
                Swal.fire({
                    title: 'Bağlantı Hatası',
                    text: 'Eşleştirme kodunuz sistemden iptal edilmiş veya bağlantı yok. Yeniden eşleşme yapmalısınız.',
                    icon: 'error'
                }).then(() => {
                    localStorage.removeItem('nkt_tenant_hash');
                    localStorage.removeItem('nkt_username');
                    localStorage.removeItem('nkt_user_hash');
                    location.reload();
                });
            }
        }

        function filterCategories() {
            const selectedType = document.getElementById('frmType').value;
            const catSel = document.getElementById('frmCat');
            catSel.innerHTML = '<option value="">Seçiniz</option>';
            
            allCategories.forEach(c => {
                if(c.type === selectedType || c.type === 'CARI') {
                    catSel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                }
            });
        }

        function checkCurrency() {
            const safeSel = document.getElementById('frmSafe');
            const selectedOption = safeSel.options[safeSel.selectedIndex];
            if(!selectedOption || !selectedOption.dataset.curr) return;
            
            const curr = selectedOption.dataset.curr;
            const div = document.getElementById('foreignCurrencyDiv');
            
            if(curr === 'TRY') {
                div.classList.add('hidden');
                document.getElementById('frmForeignAmount').value = '0';
                document.getElementById('frmRate').value = '1';
            } else {
                div.classList.remove('hidden');
                document.getElementById('frmForeignAmount').value = '';
                document.getElementById('frmRate').value = '';
            }
        }

        function calcTl() {
            const fAmt = parseFloat(document.getElementById('frmForeignAmount').value) || 0;
            const rate = parseFloat(document.getElementById('frmRate').value) || 1;
            document.getElementById('frmAmount').value = (fAmt * rate).toFixed(2);
        }

        async function saveTransaction() {
            if (document.getElementById('hp_website').value !== "") { return; }

            const btn = document.getElementById('btnSave');
            btn.disabled = true;
            btn.innerHTML = 'Gönderiliyor...';

            try {
                const countRes = await runTursoQuery(`SELECT COUNT(*) FROM Inbox_${tenantHash}`);
                if(countRes.results[0].response.result.rows[0][0].value >= 50) {
                    Swal.fire('Kota Doldu', 'Bilgisayardan bekleyen işlemleri onaylamadan yeni işlem gönderemezsiniz.', 'warning');
                    btn.disabled = false;
                    btn.innerHTML = 'İşlemi Gönder';
                    return;
                }

                let amount = parseFloat(document.getElementById('frmAmount').value) || 0;
                let kdvRate = parseFloat(document.getElementById('frmKdv').value) || 0;
                let kdvAmount = 0;
                let isKdvInc = document.getElementById('frmKdvIncluded').checked;

                if(kdvRate > 0) {
                    if(isKdvInc) {
                        let baseAmt = amount / (1 + (kdvRate / 100));
                        kdvAmount = amount - baseAmt;
                    } else {
                        kdvAmount = amount * (kdvRate / 100);
                        amount = amount + kdvAmount; 
                    }
                }

                const payload = {
                    CreatedBy: username, 
                    UserHash: userHash, 
                    Date: document.getElementById('frmDate').value,
                    Time: document.getElementById('frmTime').value + ":00",
                    CariId: document.getElementById('frmCari').value ? parseInt(document.getElementById('frmCari').value) : null,
                    SafeId: parseInt(document.getElementById('frmSafe').value),
                    CategoryId: parseInt(document.getElementById('frmCat').value),
                    Type: document.getElementById('frmType').value,
                    Amount: amount,
                    ForeignAmount: parseFloat(document.getElementById('frmForeignAmount').value) || 0,
                    Rate: parseFloat(document.getElementById('frmRate').value) || 1,
                    KdvRate: kdvRate,
                    KdvAmount: kdvAmount,
                    IsKdvIncluded: isKdvInc,
                    Description: document.getElementById('frmDesc').value
                };

                const jsonStr = JSON.stringify(payload);
                const encrypted = encryptData(jsonStr);

                await runTursoQuery(`INSERT INTO Inbox_${tenantHash} (EncryptedData) VALUES (?)`, [{ type: "text", value: encrypted }]);

                Swal.fire({
                    title: 'Başarılı!',
                    text: 'İşlem bilgisayarın onayına gönderildi.',
                    icon: 'success',
                    confirmButtonColor: '#10b981'
                }).then(() => {
                    document.getElementById('frmAmount').value = '';
                    document.getElementById('frmDesc').value = '';
                    checkCurrency();
                });

            } catch (error) {
                Swal.fire('Hata', 'Gönderim başarısız. İnternet bağlantınızı kontrol edin.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'İşlemi Gönder';
            }
        }
    </script>
</body>
</html>
